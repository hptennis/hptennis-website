<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HP Membership Page</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="../css/membership.css">
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css"> -->
    <link rel="stylesheet" href="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.2/b-flash-1.5.2/b-html5-1.5.2/b-print-1.5.2/datatables.min.css">
    
    

</head>

<body>

    <div class="w3-container w3-teal">
        <h1>Hampden Park Tennis Membership</h1>

    </div>
    <p>
        <div class="w3-container">
            <div class="w3-row w3-padding-16">
                <a id="btnShow" class="w3-button w3-large w3-circle w3-xlarge w3-ripple w3-teal" style="z-index:0">+</a>
                <button id="btnEmailView" class="w3-button w3-black">Show Email View</button>
                <button id="btnFullView" class="w3-button w3-black">Show Full View</button>
                <button id="tempAddMemberBtn" onclick="tempAddMemberBtn()" class="w3-btn w3-teal">Temp Add Member</button>
                <!-- <button id="btUpdate" class="w3-button w3-black">Update</button> -->
            </div>


            <table id="example" class="display" style="width:100%">
                <thead>
                    <!-- <tr>
                                        <th>Date</th>
                                        <th>Number</th>
                                        <th>Name</th>
                                        <th>Surname</th>
                                        <th>Addres1</th>
                                        <th>Town</th>
                                        <th>Post Code</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>XXX</th>
                                        <th>Membership</th>
                                        <th>Renewal</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                            <th>Date</th>
                                            <th>Number</th>
                                            <th>Name</th>
                                            <th>Surname</th>
                                            <th>Addres1</th>
                                            <th>Town</th>
                                            <th>Post Code</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>XXX</th>
                                            <th>Membership</th>
                                            <th>Renewal</th>
                                    </tr> -->
                    </tfoot>
            </table>


            <table id="example2" class="display" width="100%"></table>

            <div id="id01" class="w3-modal">
                <div class="w3-modal-content">

                    <header class="w3-container w3-teal">
                        <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-display-topright">&times;</span>
                        <h2>Member Detail</h2>
                    </header>

                    <div class="w3-container">
                        <form id="memberform">
                            <input id="id01key" class="" type="text" name="id01key" placeholder="" hidden>
                            <input id="id01serial" class="" type="text" name="id01serial" placeholder="" hidden>
                            <div class="w3-row">
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01firstname">First Name</label>
                                    <input id="id01firstname" class="w3-input w3-border w3-round" type="text" name="id01firstname" placeholder="First Name">
                                </div>
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01lastname">Last Name</label>
                                    <input id="id01lastname" class="w3-input w3-border" type="text" name="id01lastname" placeholder="Last Name">
                                </div>
                            </div>
                            <div class="w3-row">
                                <div class="w3-rest">
                                    <label class="w3-text-teal" for="id01address1">Address Line 1</label>
                                    <input id="id01address1" class="w3-input w3-border" name="id01address1" type="text">
                                </div>
                            </div>
                            <div class="w3-row">
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01address2">Address Line 2</label>
                                    <input id="id01address2" class="w3-input w3-border" name="id01address2" type="text">
                                </div>
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01postcode">Post Code</label>
                                    <input id="id01postcode" class="w3-input w3-border" name="id01postcode" type="text">
                                </div>
                            </div>

                            <div class="w3-row">
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01email">Email Address</label>
                                    <input id="id01email" class="w3-input w3-border w3-round" type="text" name="id01email" placeholder="email address">
                                </div>
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01phone">Phone Number</label>
                                    <input id="id01phone" class="w3-input w3-border" type="text" name="id01phone" placeholder="Phone number">
                                </div>
                            </div>
                            <div class="w3-row">
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id03membershiptype">Membership Type</label>
                                    <select id="id03membershiptype" class="w3-select w3-border" name="id03membershiptype" required>
                                        <option value="" disabled selected>Please select your membership type</option>
                                        <option value="adult">Adult Full Membership (£180)</option>
                                        <option value="family">Family(£288)</option>
                                        <option value="student">Student (£52)</option>
                                        <option value="offpeak">Off Peak Membership (£90)</option>
                                        <option value="trialA">Trial Membership Adult (£36)</option>
                                    </select>

                                </div>
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01endDate">Trial End Date</label>
                                    <input id="id01endDate" class="w3-input w3-border" type="date" name="id01endDate" placeholder="Trial End Date">
                                </div>
                            </div>
                            <div class="w3-row">
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id03rDate">Last Renewal Date</label>
                                    <input id="id03rDate" class="w3-input w3-border" type="date" name="id03rDate" placeholder="Trial End Date">
                                </div>
                                <div class="w3-half">
                                    <label class="w3-text-teal" for="id01rTime">Last Renewal Time</label>
                                    <input id="id01rTime" class="w3-input w3-border"  name="id01rTime" placeholder="">
                                </div>
                            </div>
                            <div id="createBtnRow" class="w3-show w3-row-padding">
                                    <div class="w3-third">        
                                        <button id="addMemberBtn" class="w3-btn w3-teal">Add Member</button>
                                    </div>
                                </div>
                            <div id="updateBtnRow" class="w3-hide w3-row-padding">
                                <button id="btnDelete" class="w3-button w3-black">Delete</button>
                                <button id="btUpdate" class="w3-button w3-black">Update</button>
                            </div>
                        </form>
                    </div>
                    <footer class="w3-container w3-teal">
                        <p></p>
                    </footer>

                </div>
            </div>

        </div>

        <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>

        <!-- Add Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-database.js"></script>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous">
        </script>

        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

        <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>
        <script src="https://cdn.datatables.net/select/1.2.7/js/dataTables.select.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.2/b-flash-1.5.2/b-html5-1.5.2/b-print-1.5.2/datatables.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
     
        <!-- <script src="../firebase.js"></script>-->
     
        <script src="members.js"></script>
        <script src="membership.js"></script>
      

        <script>
  
            var table;

            var membersData = [];

            // var url = "https://script.google.com/macros/s/AKfycby6wkVv9xbATIt8JVeZR71nYxnaKy3n60UJznWo5PYdPaTH2lmT/exec";

            // $.getJSON(url, function (data) {
            //     //dataSet2 = data;
            //     // table.draw(true);
            //     console.log("data:" + data);
            // });

        document.addEventListener('DOMContentLoaded', function() {

            console.log("DOMContentLoaded");
            
            firebase_init();

            // readMembersData();



        table = $('#example').DataTable({
                        dom: 'lBrftip',
                        buttons: [
                        'copy', 'csv', 'excel', 'pdf'
                        ],
                        select: true,
                        data: membersData,
                        "order": [[3, "asc"]],
                        "scrollX": true,
                        
                        columns: [
                                    { title: "Date",  "data": "timestamp" },
                                    { title: "Serial", "data": "serial" },
                                    { title: "Name", "data": "firstname" },
                                    { title: "Surname","data": "surname" },
                                    { title: "Email","data": "email" },
                                    { title: "Email Option","data": "emailoption" },
                                    { title: "Address 1","data": "address1" },
                                    { title: "Address 2","data": "address2" },
                                    { title: "Postcode","data": "postcode" },
                                    { title: "Phone","data": "phone" },
                                    { title: "Payment","data": "paymenttype" },
                                    { title: "Membership","data": "membershiptype" },
                                    { title: "Trial End","data": "trailEndDate" },
                                    { title: "Expires","data": "timestamp" }
                        ],
                        "columnDefs": [
                            {
                                "targets": [0],
                                //  render: $.fn.dataTable.render.moment( 'YYYY-MM-DD HH:mm:ss.SSS', 'DD-MM-YYYY HH:mm:ss' )
                                render: function (data, type, row) {
                                    // console.info ("data:", data);
                                    // const res = moment(Math.floor(data)).format('DD-MM-YYYY HH:mm');
                                    const res = getShortDate(data)
                                    // console.info ("display:" , res);
                                    return res ;
                                }
                            },
                            {
                                "targets": [1],
                                "visible": false,
                                "searchable": false
                            },
                            {
                                "targets": [12],
                                //  render: $.fn.dataTable.render.moment( 'YYYY-MM-DD HH:mm:ss.SSS', 'DD-MM-YYYY HH:mm:ss' )
                                render: function (data, type, row) {
                                    // var date = moment(data);

                                   

                                    return getShortDate(data);// date.isValid() ? date.format('DD-MM-YY'): "";
                                }
                            },
                            {
                                "targets": [13],
                                //  render: $.fn.dataTable.render.moment( 'YYYY-MM-DD HH:mm:ss.SSS', 'DD-MM-YYYY HH:mm:ss' )
                                render: function (data, type, row) {
                                    // var date = moment(data);
                                    if (row.membershiptype==="trialA")
                                   
                                        return  moment(row.trailEndDate).format("DD-MM-YYYY");    
                                   
                                    return getExpiry (data,'DD-MM-YYYY')
                                    // return getShortDate(data);// date.isValid() ? date.format('DD-MM-YY'): "";
                                }
                            }
                        ]
                    }
                    );

                    table
                        .on('select', function (e, dt, type, indexes) {
                            var rowData = table.rows(indexes).data().toArray();
                            console.log("row selected:" + JSON.stringify(rowData));
                            $("#id01key").val(rowData[0]["key"]);
                            $("#id01serial").val(rowData[0]["serial"]);
                            $("#id01firstname").val(rowData[0]["firstname"]);
                            $("#id01lastname").val(rowData[0]["surname"]);
                            $("#id01address1").val(rowData[0]["address1"]);
                            $("#id01address2").val(rowData[0]["address2"]);
                            $("#id01postcode").val(rowData[0]["postcode"]);
                            $("#id01email").val(rowData[0]["email"]);
                            $("#id01phone").val(rowData[0]["phone"]);
                            $("#id03membershiptype").val(rowData[0]["membershiptype"]);
                            $("#id03rDate").val(moment(rowData[0]["timestamp"]).format("YYYY-MM-DD"));
                            $("#id01rTime").val(moment(rowData[0]["timestamp"]).format("HH:MM:SS"));

                            // var date = moment(rowData[0][12]);
                            // var dateVal = date.isValid() ? date.format('DD-MM-YY'): "";
                            $("#id01endDate").val(getDateForInput(rowData[0]["trailEndDate"]));

                            if(rowData[0]["membershiptype"]==="trialA")
                            {
                                $("#id01endDate").val(getDateForInput(rowData[0]["trailEndDate"]));
                            }
                            else
                            {
                                $("#id01endDate").val(getExpiry (rowData[0]["timestamp"],'YYYY-MM-DD'));
                            }

                            showHide(false,"createBtnRow");
                            showHide(true,"updateBtnRow");
                            document.getElementById('id01').style.display = 'block'
                            // events.prepend('<div><b>' + type + ' selection</b> - ' + JSON.stringify(rowData) + '</div>');
                        })
                        .on('deselect', function (e, dt, type, indexes) {
                            var rowData = table.rows(indexes).data().toArray();
                            console.log("row deselected:" + JSON.stringify(rowData));

                            // events.prepend('<div><b>' + type + ' <i>de</i>selection</b> - ' + JSON.stringify(rowData) + '</div>');
                        });

        });


       



            $(document).ready(function () {

                console.log("document ready");

 
            });

         

            function getExpiry (timestamp,formatStr)
            {
                var expiry = moment(Math.floor(timestamp)) 
                expiry.add(1,"year");
                expiry.month("March");
                expiry.date(31);
                var res = expiry.format(formatStr);
                // console.log("exipiry date is:",res)
                return res;
            }

            function getShortDate(dateStr) {
                var date = moment(dateStr);
                var dateVal = date.isValid() ? date.format('DD-MM-YYYY') : "";
                return dateVal;
            }

            function getDateForInput(dateStr) {

                var now = new Date();

                var day = ("0" + now.getDate()).slice(-2);
                var month = ("0" + (now.getMonth() + 1)).slice(-2);

                var today = now.getFullYear() + "-" + (month) + "-" + (day);
                var date = moment(dateStr);
                var dateVal = date.isValid() ? date.format('YYYY-MM-DD') : "";

                console.log("getDateForInput:", dateVal);
                return dateVal;
            }


            function validateId01() {

                return true;

                $("#memberForm").validate;
                return $("#id01firstname").valid() &
                    $("#id01lastname").valid()

                    // & $("#id01address1").valid() 
                    // & $("#id01address2").valid() 
                    // & $("#id01postcode").valid() 
                    // & $("#id01email").valid() 
                    // & $("#id01phone").valid() 
                    ;
            }

            function validateId03() {
                $("#memberForm").validate;


                return $("#id03membershiptype").valid() &
                    $("#id03paymenttype").valid();
            }

            $("#btnShow").click(function (event) {
             
                document.getElementById('id01').style.display = 'block'
                showHide(true, "createBtnRow");

            });
            

            $("#btnEmailView").click(function (event) {

                var table = $('#example').DataTable();

                table.column(0).visible(false, false);
                table.column(4).visible(false, false);
                table.column(5).visible(false, false);
                table.column(6).visible(false, false);
                table.column(9).visible(false, false);
                table.column(10).visible(false, false);
                table.column(11).visible(false, false);
                table.column(12).visible(false, false);
                table.columns.adjust().draw(false); // adjust column sizing and redraw

            });

            $("#btnFullView").click(function (event) {

                var table = $('#example').DataTable();
                table.column(0).visible(true, false);
                table.column(4).visible(true, false);
                table.column(5).visible(true, false);
                table.column(6).visible(true, false);
                table.column(9).visible(true, false);
                table.column(10).visible(true, false);
                table.column(11).visible(true, false);
                table.column(12).visible(true, false);
                table.columns.adjust().draw(false); // adjust column sizing and redraw

            });


            $("#btUpdate").click(function (event) {

                if (validateId01()) {

                    event.preventDefault();

                    var data = {
                            "serial": $('#id01serial').val(),
                            "firstname": $('#id01firstname').val(),
                            "surname": $('#id01lastname').val(),
                            "address1":  $('#id01address1').val(),
                            "address2": $('#id01address2').val(),
                            "postcode": $('#id01postcode').val(),
                            "phone": $('#id01phone').val(),
                            "email": $('#id01email').val(),
                            "membership_type": $('#id03membershiptype').val(),
                            "endDate": $("#id01endDate").val()
                        };

                    $("body").toggleClass("wait");

                  var writeEntryResult = writeEntry($('#id01key').val(), data);

                  if (writeEntryResult === "ok")
                  {
                        alert("record updated");
                  }
                  else
                  {
                    alert("record update failed");
                  }

                };

            });


            $("#btnDelete").click(function (event) {




                var serial = $('#id01serial').val();

                confirm("Confirm you wish to delete this entry!");

                event.preventDefault();
                $("body").toggleClass("wait");
                $.ajax({
                    url: url,
                    type: "post", //send it through get method
                    data: {
                        ajaxid: 4,
                        serial: serial,
                        action: 'delete'
                    },
                    success: function (response, textStatus, jqXHR) {
                        {

                            $("body").toggleClass("wait");

                            var table = $('#example').DataTable();

                            // table.ajax.reload(function (json) {
                            //    console.log("reloaded");
                            // });

                            location.reload();

                            // alert("success!");
                            // disaply modal


                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("error:", textStatus);

                        alert("An error occured with delete, contact grant");

                        //Do Something to handle error
                        // console.error(
                        //     "The following error occurred: " +
                        //     textStatus, errorThrown
                        // );
                    }
                });
            });

        </script>
</body>

</html>